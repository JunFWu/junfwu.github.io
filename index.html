<html>
<head>
    <script id="worker">
        var loopIntervalid = undefined;

        function loopOpen(loopCount, downSecond) {
            if (loopCount > 30) {
                postMessage("stop_success");
                return;
            }

            downSecond = downSecond - 1;
            if (downSecond <= 0) {

                postMessage({ action: "open_url", value: downSecond });

                loopCount = loopCount + 1;
                downSecond = Math.floor(Math.random() * (20 - 5 + 1)) + 5;


                postMessage({ action: "change_down", value: downSecond });
                loopIntervalid = setTimeout(() => this.loopOpen(loopCount, downSecond), 1000);
            }
            else {

                postMessage({ action: "change_down", value: downSecond });
                loopIntervalid = setTimeout(() => this.loopOpen(loopCount, downSecond), 1000);
            }
        }


        addEventListener('message', function (e) {
            if (e.data == 'start') {
                if (!loopIntervalid) {
                    this.loopOpen(0, 0);
                }

            } else if (e.data == 'stop') {

                console.log("stop", loopIntervalid);

                if (loopIntervalid) {
                    clearTimeout(loopIntervalid);
                    postMessage({ action: "stop_success", value: undefined });
                }
            }
        }, false);


    </script>

    <script>
        var worker = undefined;
        var btnEl = undefined;
        var btnStopFlag = undefined;

        function uuid() {
            var s = [];
            var hexDigits = "0123456789abcdef";
            for (var i = 0; i < 36; i++) {
                s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
            }
            s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
            s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
            s[8] = s[13] = s[18] = s[23] = "-";

            var uuid = s.join("");
            return uuid;
        }

        function getStopFlag() {
            if (btnStopFlag.innerText) {
                return true;
            } else {
                return false;
            }
        }

        function setStopFlag(flag) {
            if (flag) {
                btnStopFlag.innerText = "stop";
            } else {
                btnStopFlag.innerText = "";
            }

        }




        function init() {
            var blob = new Blob([document.querySelector('#worker').textContent]);
            var url = window.URL.createObjectURL(blob);
            worker = new Worker(url);

            worker.onmessage = function (e) {
                if (!e.data) {
                    return;
                }
                console.log(e.data);

                if (e.data.action == "open_url") {
                    let iframe = document.getElementById("iframeShow");
                    iframe.src = `https://cn.bing.com/search?q=${uuid()}&ensearch=1&FORM=BESBTB`;
                }
                else if (e.data.action == "change_down") {




                    btnEl.innerText = e.data.value;
                }
                else if (e.data.action == "stop_success") {
                    btnEl.innerText = "积分";

                    worker.terminate();
                    worker = undefined;
                }
            };
        }


        function openjifen() {
            if (!btnEl) {
                btnEl = document.getElementById("btnJifen");
            }

            if (!btnStopFlag) {
                btnStopFlag = document.getElementById("stopFlag");
            }

            console.log("worker", worker);
            if (!worker) {
                this.init();
            }

            if (btnEl.innerText == "积分") {
                this.setStopFlag(false);
                this.loopOpen(0, 0);

                // 开启循环
                worker.postMessage("start");
            } else {
                this.setStopFlag(true);
                worker.postMessage("stop");
                // 停止计算
            }
        }


    </script>

    <style>
        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            border: 0;
        }

        @keyframes float-vertical {
            0% {
                box-shadow: 0 0 2vw 0vw lightskyblue;
            }

            50% {
                box-shadow: 0 0 30vw 0vw lightskyblue;
            }


            100% {
                box-shadow: 0 0 2vw 0vw lightskyblue;
            }
        }


        .jifen-button {
            width: 40vw;
            height: 40vw;
            border-radius: 50%;
            background: lightskyblue;
            border: none;
            color: white;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 10vw;
            animation: float-vertical 1.5s infinite;

        }
    </style>

</head>
<body style="text-align:center">

    <div style="width:100vw;height:100vh;overflow: hidden;position:relative">
        <iframe id="iframeShow" style="width: 100%;height:100%"></iframe>
    </div>
    <div style="width:100vw;height:100vh;overflow: hidden;position:fixed;left:0;top:0;background-color: #0AA2;">


    </div>
    <button id="btnJifen" onclick="openjifen()" class="jifen-button">积分</button>

    <input id="stopFlag" hidden></input>
</body>
</html>
